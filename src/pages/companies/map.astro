---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import atlasScriptUrl from "../../scripts/atlas-map.ts?url";

const all = await getCollection("companies");
const posts = all.filter((p) => !p.data.draft);

const points = posts
  .filter((p) => typeof p.data.lat === "number" && typeof p.data.lon === "number")
  .map((p) => ({
    slug: p.slug,
    title: p.data.title.replace(/^\d+\s*—\s*/, ""),
    kind: p.data.kind,
    region: p.data.region,
    website: p.data.website ?? null,
    location: p.data.location ?? null,
    lat: p.data.lat,
    lon: p.data.lon,
  }));

const missingCount = posts.length - points.length;
---

<Layout
  pageTitle="BCI Atlas — Map"
  subtitle="A map view of company and lab locations (entries appear once we add lat/lon in frontmatter)."
  description="BCI Atlas map view — click a marker to open the brief."
>
  <section class="card">
    <p class="muted">
      Click any marker to open the corresponding brief. If something you expect isn’t shown, it just means we haven’t
      added coordinates yet.
      {missingCount > 0 ? ` (${missingCount} entries currently missing coordinates.)` : ""}
    </p>
    <p class="muted" style="margin-top:10px;">
      Back to the directory → <a href="/companies/">BCI Atlas index</a>
    </p>
  </section>

  <section class="card">
    <div id="map" class="map" aria-label="BCI Atlas map" data-points={JSON.stringify(points)}></div>
    <noscript>
      <p class="muted" style="margin-top:12px;">JavaScript is required to render the interactive map.</p>
    </noscript>
  </section>

  <script type="module" src={atlasScriptUrl}></script>
</Layout>

<style>
  .card {
    margin-top: 14px;
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .muted {
    opacity: 0.72;
    margin: 0;
  }

  .map {
    width: 100%;
    height: 520px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--panelStrong);
    overflow: hidden;
  }

  @media (max-width: 720px) {
    .map {
      height: 440px;
    }
  }
</style>
