---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import atlasScriptUrl from "../../scripts/atlas-map.mjs?url";

const all = await getCollection("companies");
const posts = all.filter((p) => !p.data.draft);

const points = posts
  .filter((p) => typeof p.data.lat === "number" && typeof p.data.lon === "number")
  .map((p) => ({
    slug: p.slug,
    title: p.data.title.replace(/^\d+\s*—\s*/, ""),
    kind: p.data.kind,
    region: p.data.region,
    website: p.data.website ?? null,
    location: p.data.location ?? null,
    lat: p.data.lat,
    lon: p.data.lon,
  }));

const missingCount = posts.length - points.length;
---

<Layout
  pageTitle="BCI Atlas — Map"
  subtitle="A map view of company and lab locations (entries appear once we add lat/lon in frontmatter)."
  description="BCI Atlas map view — click a marker to open the brief."
>
  <section class="card">
    <p class="muted">
      Click any marker to open the corresponding brief. If something you expect isn’t shown, it just means we haven’t
      added coordinates yet.
      {missingCount > 0 ? ` (${missingCount} entries currently missing coordinates.)` : ""}
    </p>
    <p class="muted" style="margin-top:10px;">
      Back to the directory → <a href="/companies/">BCI Atlas index</a>
    </p>
  </section>

  <section class="card">
    <div id="map" class="atlasMap" data-points={JSON.stringify(points)} aria-label="BCI Atlas world map"></div>
    <noscript>
      <p class="muted" style="margin-top:12px;">JavaScript is required to use the atlas map.</p>
    </noscript>
    <script type="module" src={atlasScriptUrl}></script>
  </section>
</Layout>

<style>
  .card {
    margin-top: 14px;
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .muted {
    opacity: 0.72;
    margin: 0;
  }

  .atlasMap {
    width: 100%;
    height: 620px;
    border-radius: 14px;
    border: 1px solid var(--border);
    overflow: hidden;
    background: var(--panelStrong);
  }

  :global(.atlasMarkerWrap) {
    background: transparent;
    border: 0;
  }

  :global(.atlasMarkerPin) {
    width: 100%;
    height: 100%;
    border-radius: 999px;
    background: radial-gradient(circle at 32% 30%, #ffb9b9 0%, #ff6a6a 35%, #d83030 70%, #a81d1d 100%);
    border: 1px solid rgba(80, 8, 8, 0.65);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.45), 0 5px 12px rgba(0, 0, 0, 0.24);
  }

  :global(.leaflet-popup-content-wrapper) {
    border-radius: 10px;
  }

  @media (max-width: 720px) {
    .atlasMap {
      height: 520px;
    }
  }
</style>
