---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import atlasScriptUrl from "../../scripts/atlas-map.ts?url";

const all = await getCollection("companies");
const posts = all.filter((p) => !p.data.draft);

const points = posts
  .filter((p) => typeof p.data.lat === "number" && typeof p.data.lon === "number")
  .map((p) => ({
    slug: p.slug,
    title: p.data.title.replace(/^\d+\s*—\s*/, ""),
    kind: p.data.kind,
    region: p.data.region,
    website: p.data.website ?? null,
    location: p.data.location ?? null,
    lat: p.data.lat,
    lon: p.data.lon,
  }));

const missingCount = posts.length - points.length;
---

<Layout
  pageTitle="BCI Atlas — Map"
  subtitle="A map view of company and lab locations (entries appear once we add lat/lon in frontmatter)."
  description="BCI Atlas map view — click a marker to open the brief."
>
  <section class="card">
    <p class="muted">
      Click any marker to open the corresponding brief. If something you expect isn’t shown, it just means we haven’t
      added coordinates yet.
      {missingCount > 0 ? ` (${missingCount} entries currently missing coordinates.)` : ""}
    </p>
    <p class="muted" style="margin-top:10px;">
      Back to the directory → <a href="/companies/">BCI Atlas index</a>
    </p>
  </section>

  <section class="card">
    <!-- Fallback map that always works: pan/zoom a real world SVG with clickable pins. -->
    <div class="staticMap" id="staticMap" aria-label="BCI Atlas map (pan and zoom)">
      <div class="viewport" id="mapViewport">
        <img class="mapImg" id="mapImg" src="/atlas-world.svg" alt="World map" draggable="false" />

        <!-- Test pin requested: New York City → Wikipedia -->
        <a
          class="pin"
          data-lat="40.7128"
          data-lon="-74.0060"
          href="https://en.wikipedia.org/wiki/New_York_City"
          target="_blank"
          rel="noopener noreferrer"
          title="New York City"
          aria-label="New York City"
        ></a>
      </div>
    </div>

    <noscript>
      <p class="muted" style="margin-top:12px;">JavaScript is required to pan/zoom the atlas.</p>
    </noscript>

    <!-- Still load the interactive Leaflet map script (markers + tiles) when available. -->
    <script type="module" src={atlasScriptUrl}></script>

    <!-- Always-on pan/zoom + pin positioning for the SVG fallback. -->
    <script type="module" is:inline>
      const host = document.getElementById('staticMap');
      const viewport = document.getElementById('mapViewport');
      if (!host || !viewport) {
        // nothing
      } else {
        // Position pins using equirectangular projection.
        // x% = (lon + 180) / 360
        // y% = (90 - lat) / 180
        const pins = Array.from(viewport.querySelectorAll('.pin'));
        for (const pin of pins) {
          const lat = Number(pin.getAttribute('data-lat'));
          const lon = Number(pin.getAttribute('data-lon'));
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          const x = (lon + 180) / 360;
          const y = (90 - lat) / 180;
          pin.style.left = `${(x * 100).toFixed(4)}%`;
          pin.style.top = `${(y * 100).toFixed(4)}%`;
        }

        // Pan/zoom (very small, reliable implementation)
        let scale = 1;
        let tx = 0;
        let ty = 0;
        let dragging = false;
        let lastX = 0;
        let lastY = 0;

        const apply = () => {
          viewport.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
        };

        // Wheel zoom (centered on cursor)
        host.addEventListener('wheel', (e) => {
          e.preventDefault();
          const rect = host.getBoundingClientRect();
          const cx = e.clientX - rect.left;
          const cy = e.clientY - rect.top;

          const zoomFactor = Math.exp(-e.deltaY * 0.001);
          const next = Math.min(6, Math.max(0.8, scale * zoomFactor));

          // Keep cursor position stable during zoom.
          const k = next / scale;
          tx = cx - k * (cx - tx);
          ty = cy - k * (cy - ty);
          scale = next;
          apply();
        }, { passive: false });

        // Drag pan
        const onDown = (e) => {
          dragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          host.classList.add('dragging');
        };
        const onMove = (e) => {
          if (!dragging) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX;
          lastY = e.clientY;
          tx += dx;
          ty += dy;
          apply();
        };
        const onUp = () => {
          dragging = false;
          host.classList.remove('dragging');
        };

        host.addEventListener('mousedown', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);

        // Touch support
        host.addEventListener('touchstart', (e) => {
          if (e.touches.length !== 1) return;
          onDown(e.touches[0]);
        }, { passive: true });
        host.addEventListener('touchmove', (e) => {
          if (e.touches.length !== 1) return;
          onMove(e.touches[0]);
        }, { passive: true });
        host.addEventListener('touchend', onUp, { passive: true });

        apply();
      }
    </script>
  </section>
</Layout>

<style>
  .card {
    margin-top: 14px;
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .muted {
    opacity: 0.72;
    margin: 0;
  }

  .staticMap {
    width: 100%;
    height: 520px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--panelStrong);
    overflow: hidden;
    position: relative;
    cursor: grab;
    user-select: none;
    touch-action: none;
  }

  .staticMap.dragging {
    cursor: grabbing;
  }

  .viewport {
    position: absolute;
    inset: 0;
    transform-origin: 0 0;
    will-change: transform;
  }

  .mapImg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }

  .pin {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 999px;
    border: 2px solid var(--borderStrong);
    background: rgba(220, 40, 40, 0.92);
    box-shadow: 0 8px 20px var(--shadow);
    transform: translate(-50%, -50%);
    cursor: pointer;
  }

  .pin:hover {
    transform: translate(-50%, -50%) scale(1.15);
    border-color: rgba(255, 255, 255, 0.5);
  }

  @media (max-width: 720px) {
    .staticMap {
      height: 440px;
    }
  }
</style>
