---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const all = await getCollection("companies");
const posts = all.filter((p) => !p.data.draft);

const points = posts
  .filter((p) => typeof p.data.lat === "number" && typeof p.data.lon === "number")
  .map((p) => ({
    slug: p.slug,
    title: p.data.title.replace(/^\d+\s*—\s*/, ""),
    kind: p.data.kind,
    region: p.data.region,
    website: p.data.website ?? null,
    location: p.data.location ?? null,
    lat: p.data.lat,
    lon: p.data.lon,
  }));

const missingCount = posts.length - points.length;
---

<Layout
  pageTitle="BCI Atlas — Map"
  subtitle="A map view of company and lab locations (entries appear once we add lat/lon in frontmatter)."
  description="BCI Atlas map view — click a marker to open the brief."
>
  <section class="card">
    <p class="muted">
      Click any marker to open the corresponding brief. If something you expect isn’t shown, it just means we haven’t
      added coordinates yet.
      {missingCount > 0 ? ` (${missingCount} entries currently missing coordinates.)` : ""}
    </p>
    <p class="muted" style="margin-top:10px;">
      Back to the directory → <a href="/companies/">BCI Atlas index</a>
    </p>
  </section>

  <section class="card">
    <div id="map" class="map" aria-label="BCI Atlas map"></div>
  </section>

  <script is:inline>
    // Leaflet map (CDN). Client-side only.
    const points = {JSON.stringify(points)};

    function loadCss(href) {
      return new Promise((resolve, reject) => {
        const el = document.createElement("link");
        el.rel = "stylesheet";
        el.href = href;
        el.onload = resolve;
        el.onerror = reject;
        document.head.appendChild(el);
      });
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const el = document.createElement("script");
        el.src = src;
        el.onload = resolve;
        el.onerror = reject;
        document.head.appendChild(el);
      });
    }

    (async () => {
      try {
        await loadCss("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css");
        await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");

        const L = window.L;
        const el = document.getElementById("map");
        if (!L || !el) return;

        const map = L.map(el, { scrollWheelZoom: true });

        // OSM tiles (simple + reliable).
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        if (!points.length) {
          map.setView([20, 0], 2);
          return;
        }

        const bounds = [];
        points.forEach((p) => {
          const marker = L.marker([p.lat, p.lon]).addTo(map);
          bounds.push([p.lat, p.lon]);

          const safeTitle = String(p.title || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const safeLoc = p.location ? String(p.location).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";

          const html = `
            <div style="font-family: 'Times New Roman', Times, serif;">
              <div style="font-weight:700; margin-bottom:6px;">${safeTitle}</div>
              <div style="opacity:0.75; margin-bottom:8px; font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">
                ${p.kind} — ${p.region}
              </div>
              ${safeLoc ? `<div style="opacity:0.8; margin-bottom:10px;">${safeLoc}</div>` : ""}
              <div>
                <a href="/companies/${p.slug}/" style="text-decoration:underline; color:inherit;">Open brief →</a>
              </div>
            </div>
          `;

          marker.bindPopup(html);
        });

        map.fitBounds(bounds, { padding: [24, 24] });
      } catch (e) {
        // If CDN blocked or offline, fail silently (page still useful).
        console.warn("Map init failed", e);
      }
    })();
  </script>
</Layout>

<style>
  .card {
    margin-top: 14px;
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .muted {
    opacity: 0.72;
    margin: 0;
  }

  .map {
    width: 100%;
    height: 520px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--panelStrong);
    overflow: hidden;
  }

  @media (max-width: 720px) {
    .map {
      height: 440px;
    }
  }
</style>
