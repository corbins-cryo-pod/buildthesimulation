---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const all = await getCollection("companies");
const posts = all.filter((p) => !p.data.draft);

function titleWithoutPrefix(title) {
  return title.replace(/^\d+\s*[-â€”]\s*/, "");
}

function atlasTitle(title) {
  return titleWithoutPrefix(title).replace(/\s*\((company|lab) brief\)$/i, "");
}

function sortBySizeThenTitle(a, b) {
  const ar = a.data.sizeRank ?? Number.POSITIVE_INFINITY;
  const br = b.data.sizeRank ?? Number.POSITIVE_INFINITY;
  if (ar !== br) return ar - br;
  return atlasTitle(a.data.title).localeCompare(atlasTitle(b.data.title));
}

const american = posts
  .filter((p) => p.data.kind === "Company" && p.data.region === "American")
  .sort(sortBySizeThenTitle);
const european = posts
  .filter((p) => p.data.kind === "Company" && p.data.region === "European")
  .sort(sortBySizeThenTitle);
const chinese = posts
  .filter((p) => p.data.kind === "Company" && p.data.region === "Chinese")
  .sort(sortBySizeThenTitle);
const other = posts
  .filter((p) => p.data.kind === "Company" && p.data.region === "Other")
  .sort(sortBySizeThenTitle);
const labs = posts.filter((p) => p.data.kind === "Lab").sort(sortBySizeThenTitle);

---

<Layout
  pageTitle="BCI Atlas"
  subtitle="A directory of BCI companies and labs, with links to each profile."
  description="BCI Atlas: company + lab briefs, organized by region, plus a map view."
>
  <section class="card">
    <p class="muted">
      This page lists organizations in the BCI ecosystem and links to their detailed briefs.
    </p>
    <p class="muted" style="margin-top:10px;">
      Want the geography view? â†’ <a href="/companies/map/">Open the atlas map</a>
    </p>
  </section>

  {american.length ? (
    <section class="card">
      <h2>American companies</h2>
      <div class="list">
        {american.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}>
            <h3>{atlasTitle(p.data.title)}</h3>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {european.length ? (
    <section class="card">
      <h2>European companies</h2>
      <div class="list">
        {european.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}>
            <h3>{atlasTitle(p.data.title)}</h3>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {chinese.length ? (
    <section class="card">
      <h2>Chinese companies</h2>
      <div class="list">
        {chinese.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}>
            <h3>{atlasTitle(p.data.title)}</h3>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {other.length ? (
    <section class="card">
      <h2>Other / mixed region</h2>
      <div class="list">
        {other.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}>
            <h3>{atlasTitle(p.data.title)}</h3>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {labs.length ? (
    <section class="card">
      <h2>Labs</h2>
      <div class="list">
        {labs.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}>
            <h3>{atlasTitle(p.data.title)}</h3>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </a>
        ))}
      </div>
    </section>
  ) : null}
</Layout>

<style>
  .card {
    margin-top: 14px;
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .muted {
    opacity: 0.72;
    margin: 0;
  }

  h2 {
    margin: 0 0 12px;
    font-size: var(--title-section);
    font-weight: 400;
    line-height: 1.06;
  }

  .list {
    display: grid;
    gap: 10px;
  }

  .item {
    display: block;
    padding: 14px 14px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: inherit;
    text-decoration: none;
  }

  .item:hover {
    border-color: var(--borderStrong);
    transform: translateY(-1px);
    background: var(--panelHover);
  }

  h3 {
    margin: 0;
    font-size: var(--title-card);
    font-weight: 400;
    line-height: 1.08;
  }

  .desc {
    margin: 8px 0 0;
    opacity: 0.78;
    line-height: 1.7;
  }
</style>

