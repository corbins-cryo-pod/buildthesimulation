---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

const dateMs = (v) => (v instanceof Date ? v.getTime() : 0);

const news = (await getCollection("news"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => dateMs(b.data.pubDate) - dateMs(a.data.pubDate));

const articles = (await getCollection("articles"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => dateMs(b.data.pubDate) - dateMs(a.data.pubDate));

const companies = (await getCollection("companies"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => dateMs(b.data.pubDate) - dateMs(a.data.pubDate));

const latestNews = news.slice(0, 3);
const latestArticles = articles.slice(0, 3);
const latestCompanies = companies.slice(0, 3);

const lastUpdatedCandidates = [news[0]?.data.pubDate, articles[0]?.data.pubDate, companies[0]?.data.pubDate]
  .filter((d) => d instanceof Date);
const lastUpdated = lastUpdatedCandidates.length
  ? new Date(Math.max(...lastUpdatedCandidates.map((d) => d.getTime())))
  : undefined;
---

<Layout withHero={true}>
  <section class="hero card">
    <p class="eyebrow">Build The Simulation</p>
    <h1>Understand brain interfaces by reading, exploring, and running simulations.</h1>
    <p class="lede">
      A practical neurotech learning platform: curated articles, BCI Atlas company/lab mapping, and interactive
      cortex/peripheral sandboxes you can tune in-browser.
    </p>
    <div class="ctaRow">
      <a class="btn primary" href="/simulations/">Explore simulations</a>
      <a class="btn" href="/companies/map/">Open BCI Atlas</a>
      <a class="btn" href="/articles/">Start reading</a>
    </div>
  </section>

  <section class="card">
    <div class="row"><h2>Start here</h2></div>
    <div class="pathGrid">
      <a class="path" href="/articles/">
        <h3>Learn the fundamentals</h3>
        <p>Go from neuroscience basics to recording, stimulation, materials, and design tradeoffs.</p>
      </a>
      <a class="path" href="/companies/map/">
        <h3>Explore companies and labs</h3>
        <p>Use the atlas to scan the ecosystem and jump into company/lab briefs.</p>
      </a>
      <a class="path" href="/simulations/">
        <h3>Run interactive simulations</h3>
        <p>Manipulate electrode placement, thresholds, and dynamics to build intuition quickly.</p>
      </a>
    </div>
  </section>

  <section class="card">
    <div class="row"><h2>Platform snapshot</h2></div>
    <div class="stats">
      <div class="stat"><div class="num">{articles.length}</div><div class="label">Articles</div></div>
      <div class="stat"><div class="num">{companies.length}</div><div class="label">Companies / labs</div></div>
      <div class="stat"><div class="num">{news.length}</div><div class="label">News posts</div></div>
      <div class="stat">
        <div class="num">{lastUpdated ? lastUpdated.toLocaleDateString("en-US", { month: "short", day: "numeric" }) : "—"}</div>
        <div class="label">Last updated</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <h2>Featured simulations</h2>
      <a class="smallLink" href="/simulations/">All simulations →</a>
    </div>
    <div class="featureGrid">
      <a class="feature" href="/simulations/cortex-slab/">
        <h3>Cortex slab</h3>
        <p>Point-electrode placement, detected spikes, raster/trace alignment, and network dynamics controls.</p>
      </a>
      <a class="feature" href="/simulations/nerve-cross-section/">
        <h3>Peripheral nerve cross-section</h3>
        <p>Explore fascicle-level geometry and interface behavior in a compact in-browser sandbox.</p>
      </a>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <h2>Latest news</h2>
      <a class="smallLink" href="/news">All news →</a>
    </div>
    {latestNews.length === 0 ? (
      <p class="muted">No published posts yet.</p>
    ) : (
      <div class="listGrid">
        {latestNews.map((p) => (
          <a class="item" href={`/news/${p.slug}/`}>
            <div class="title">{p.data.title}</div>
            <time datetime={p.data.pubDate instanceof Date ? p.data.pubDate.toISOString() : ""}>
              {p.data.pubDate instanceof Date
                ? p.data.pubDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
                : "Undated"}
            </time>
          </a>
        ))}
      </div>
    )}
  </section>

  <section class="card split">
    <div>
      <div class="row"><h2>Recent articles</h2><a class="smallLink" href="/articles">All articles →</a></div>
      <div class="listGrid compact">
        {latestArticles.map((p) => (
          <a class="item" href={`/articles/${p.slug}/`}><div class="title">{p.data.title}</div></a>
        ))}
      </div>
    </div>
    <div>
      <div class="row"><h2>Recent companies / labs</h2><a class="smallLink" href="/companies">All briefs →</a></div>
      <div class="listGrid compact">
        {latestCompanies.map((p) => (
          <a class="item" href={`/companies/${p.slug}/`}><div class="title">{p.data.name ?? p.data.title ?? p.slug}</div></a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<style>
  .card { margin-top: 14px; padding: 22px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); }
  .hero h1 { margin: 4px 0 10px; font-size: clamp(1.5rem, 3vw, 2rem); line-height: 1.2; }
  .eyebrow { margin: 0; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.72; }
  .lede { margin: 0; opacity: 0.82; max-width: 78ch; line-height: 1.55; }
  .ctaRow { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; }
  .btn { border: 1px solid var(--border); border-radius: 12px; padding: 8px 12px; text-decoration: none; color: inherit; background: var(--panelStrong); }
  .btn.primary { border-color: var(--borderStrong); background: var(--panelHover); }

  .row { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; }
  h2 { margin: 0 0 10px; font-size: 32px; }
  .smallLink { font-size: 13px; opacity: 0.75; color: inherit; text-decoration: none; white-space: nowrap; }
  .smallLink:hover { opacity: 1; }
  .muted { opacity: 0.7; }

  .pathGrid, .featureGrid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
  .featureGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .path, .feature, .item { display: block; text-decoration: none; color: inherit; border: 1px solid var(--border); border-radius: 14px; background: var(--panelStrong); }
  .path, .feature { padding: 14px; }
  .path:hover, .feature:hover, .item:hover { border-color: var(--borderStrong); background: var(--panelHover); transform: translateY(-1px); }
  .path h3, .feature h3 { margin: 0 0 6px; font-size: 32px; }
  .path p, .feature p { margin: 0; opacity: 0.8; line-height: 1.45; }

  .stats { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
  .stat { padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--panelStrong); }
  .num { font-size: 22px; font-weight: 400; line-height: 1; }
  .label { margin-top: 6px; font-size: 12px; opacity: 0.72; }

  .listGrid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
  .listGrid.compact { grid-template-columns: 1fr; }
  .item { padding: 12px; }
  .title { font-weight: 400; margin-bottom: 6px; }
  time { font-size: 12px; opacity: 0.65; }

  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  @media (max-width: 980px) {
    .pathGrid, .featureGrid, .listGrid, .stats, .split { grid-template-columns: 1fr; }
  }
</style>
