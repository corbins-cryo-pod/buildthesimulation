---
import Layout from "../../../layouts/Layout.astro";
---

<Layout
  pageTitle="Simulation"
  subtitle="Cortex slab (v1). Single movable electrode + toy spike-to-electrode model."
  description="Interactive 3D cortex slab sandbox with a single movable electrode, spike raster, and trace output."
>
  <section class="card" style="margin-top:14px;">
    <p class="muted" style="margin:0;">
      This version starts simple: one movable electrode in a 3D cortical slab. Internal units are <b>µm</b>.
      We can add multi-electrode modes after this interaction feels right. New here? See the
      <a href="/simulations/cortex-slab/guide/">cortex slab guide</a>.
    </p>
  </section>

  <section class="simShell">
    <aside class="panel" aria-label="Controls">
      <div class="panelSection">
        <div class="panelTitle">Run</div>
        <label class="lab">
          <span style="display:flex;align-items:center;gap:10px;">
            <input id="paused" type="checkbox" />
            Pause
          </span>
        </label>

        <label class="lab">
          Speed
          <div class="rangeRow">
            <input id="speed" type="range" min="0.25" max="2" step="0.05" value="1" />
            <div class="rangeMeta">
              <span class="muted">0.25× to 2×</span>
              <span id="speedLabel" class="muted">1.00×</span>
            </div>
          </div>
        </label>
      </div>

      <div class="panelSection">
        <div class="panelTitle">Electrodes (point mode)</div>
        <p id="elecMeta" class="muted" style="margin:0 0 10px;">1 electrode · selected E1</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
          <button id="elecAdd" type="button">Add point</button>
          <button id="elecRemove" type="button">Remove point</button>
          <button id="elecPrev" type="button">Prev</button>
          <button id="elecNext" type="button">Next</button>
        </div>

        <label class="lab">
          X
          <input id="elecX" type="number" min="-1000" max="1000" step="10" value="0" />
          <input id="elecXRange" type="range" min="-1000" max="1000" step="10" value="0" />
        </label>

        <label class="lab">
          Y
          <input id="elecY" type="number" min="-1000" max="1000" step="10" value="0" />
          <input id="elecYRange" type="range" min="-1000" max="1000" step="10" value="0" />
        </label>

        <label class="lab">
          Z / depth
          <input id="elecZ" type="number" min="50" max="1450" step="10" value="900" />
          <input id="elecZRange" type="range" min="50" max="1450" step="10" value="900" />
        </label>
      </div>

      <div class="panelSection">
        <div class="panelTitle">3D view</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <button id="viewReset" type="button">Reset view</button>
          <button id="viewTop" type="button">Top view</button>
          <button id="viewSide" type="button" style="grid-column:1 / -1;">Side view</button>
        </div>
        <p class="muted" style="margin-top:10px;margin-bottom:0;">Middle-drag rotate, left/right-drag pan, wheel zoom. Click slab to move selected point (hold Shift to also set depth).</p>
      </div>

      <div class="panelSection">
        <div class="panelTitle">Display</div>
        <label class="lab">
          Raster neurons shown
          <div class="rangeRow">
            <input id="nShow" type="range" min="50" max="600" value="250" />
            <div class="rangeMeta">
              <span class="muted">50 to 600</span>
            </div>
          </div>
        </label>

        <div class="panelTitle" style="margin-top:12px;">Trace controls</div>
        <label class="lab">
          <span style="display:flex;align-items:center;gap:10px;">
            <input id="spikeBandOn" type="checkbox" />
            Spike-band filter (display)
          </span>
        </label>

        <label class="lab">
          Threshold (µV)
          <input id="thrUv" type="number" min="-120" max="-2" step="1" value="-18" />
        </label>

        <label class="lab">
          Gain scale
          <div class="rangeRow">
            <input id="traceGain" type="range" min="0.5" max="3" step="0.05" value="1" />
            <div class="rangeMeta">
              <span class="muted">0.5× to 3×</span>
              <span id="traceGainLabel" class="muted">1.00×</span>
            </div>
          </div>
        </label>
      </div>
    </aside>

    <main class="stage" aria-label="Simulation canvas">
      <div class="stageBar">
        <div class="stageTitle">Cortex slab</div>
        <div class="stageHint">Single electrode + raster + trace</div>
      </div>

      <div class="stageBody">
        <canvas id="cortex3d" class="c3d"></canvas>

        <div class="miniRow">
          <section class="mini">
            <div class="miniBar">
              <div class="miniTitle">Spike raster</div>
              <div class="miniHint">electrode-detected spikes</div>
            </div>
            <canvas id="raster" width="980" height="150"></canvas>
          </section>
        </div>

        <div class="miniRow">
          <section class="mini">
            <div class="miniBar">
              <div class="miniTitle">Electrode traces</div>
              <div class="miniHint">one panel per electrode</div>
            </div>
            <canvas id="traces" width="980" height="220"></canvas>
          </section>
        </div>
      </div>
    </main>
  </section>

  <script type="module" src="/scripts/cortex-v2/main.js"></script>
</Layout>

<style>
  .simShell { margin-top: 14px; display: grid; grid-template-columns: 320px 1fr; gap: 12px; align-items: start; }
  .panel { padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); }
  .panelSection + .panelSection { margin-top: 14px; padding-top: 14px; border-top: 1px dashed var(--border); }
  .panelTitle { font-weight: 700; margin-bottom: 10px; }
  .lab { display: block; font-size: 0.95em; line-height: 1.4; margin: 0 0 12px; }
  .lab input[type="number"] { width: 100%; margin: 4px 0 6px; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--panelStrong); color: var(--text); }
  .rangeRow { margin-top: 6px; }
  .rangeMeta { margin-top: 6px; display: flex; justify-content: space-between; gap: 10px; font-size: 0.88em; }
  .muted { opacity: 0.72; }
  .stage { border-radius: 16px; border: 1px solid var(--border); background: var(--panel); overflow: hidden; }
  .stageBar { display: flex; justify-content: space-between; align-items: baseline; padding: 12px 14px; border-bottom: 1px solid var(--border); }
  .stageTitle { font-weight: 800; }
  .stageHint { opacity: 0.68; font-size: 0.95em; }
  .stageBody { padding: 12px; }
  .c3d { width: 100%; height: 460px; display: block; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); }
  .miniRow { margin-top: 12px; }
  .mini { border-radius: 12px; border: 1px solid var(--border); overflow: hidden; background: rgba(255,255,255,0.03); }
  .miniBar { display: flex; justify-content: space-between; align-items: baseline; padding: 10px 12px; border-bottom: 1px solid var(--border); }
  .miniTitle { font-weight: 700; }
  .miniHint { opacity: 0.65; font-size: 0.92em; }
  canvas { width: 100%; display: block; }
  .card { padding: 22px 22px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); }
  @media (max-width: 980px) { .simShell { grid-template-columns: 1fr; } .c3d { height: 420px; } }
</style>
