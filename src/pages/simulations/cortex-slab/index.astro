---
import Layout from "../../../layouts/Layout.astro";
import scriptUrl from "../../../scripts/cortex-slab.mjs?url";
---

<Layout
  pageTitle="Simulation"
  subtitle="Cortex slab (v0). 3D tissue + Utah array + toy spike-to-electrode model."
  description="Interactive 3D cortex slab sandbox: neuron point cloud, Utah array placement, and simple electrode traces."
>
  <section class="card" style="margin-top:14px;">
    <p class="muted" style="margin:0;">
      This is an early cortex sandbox. Units are stored internally in <b>µm</b>, but UI controls are displayed as <b>mm/µm</b>.
      The forward model is a toy (distance attenuation + fixed spike kernel), but the architecture is meant to stay stable as we upgrade realism.
    </p>
  </section>

  <section class="simShell">
    <aside class="panel" aria-label="Controls">
      <div class="panelSection">
        <div class="panelTitle">Run</div>
        <label class="lab">
          <span style="display:flex;align-items:center;gap:10px;">
            <input id="paused" type="checkbox" />
            Pause
          </span>
        </label>

        <label class="lab">
          Speed
          <div class="rangeRow">
            <input id="speed" type="range" min="1" max="6" value="1" />
            <div class="rangeMeta">
              <span class="muted">1× to 6×</span>
            </div>
          </div>
        </label>
      </div>

      <div class="panelSection">
        <div class="panelTitle">Implant</div>

        <label class="lab">
          Utah pitch (µm)
          <div class="rangeRow">
            <input id="pitch" type="range" min="200" max="600" value="400" step="10" />
            <div class="rangeMeta">
              <span id="pitchVal" class="muted"></span>
              <span class="muted">200 to 600</span>
            </div>
          </div>
        </label>

        <label class="lab">
          Insertion depth (µm)
          <div class="rangeRow">
            <input id="depth" type="range" min="200" max="1400" value="900" step="10" />
            <div class="rangeMeta">
              <span id="depthVal" class="muted"></span>
              <span class="muted">200 to 1400</span>
            </div>
          </div>
        </label>
      </div>

      <div class="panelSection">
        <div class="panelTitle">Display</div>

        <label class="lab">
          Raster neurons shown
          <div class="rangeRow">
            <input id="nShow" type="range" min="50" max="600" value="250" />
            <div class="rangeMeta">
              <span class="muted">50 to 600</span>
            </div>
          </div>
        </label>

        <p class="muted" style="margin:0;">Drag to orbit. Scroll to zoom.</p>
      </div>

      <details class="panelSection" open>
        <summary class="panelTitle">Notes</summary>
        <p class="muted" style="margin:0;">
          Neurons are Poisson spikers (baseline rates). Electrode signals are generated by summing a fixed spike kernel with distance attenuation.
        </p>
      </details>
    </aside>

    <main class="stage" aria-label="Simulation canvas">
      <div class="stageBar">
        <div class="stageTitle">Cortex slab</div>
        <div class="stageHint">3D tissue + Utah array + raster + traces</div>
      </div>

      <div class="stageBody">
        <canvas id="cortex3d" class="c3d"></canvas>

        <div class="miniRow">
          <section class="mini">
            <div class="miniBar">
              <div class="miniTitle">Spike raster</div>
              <div class="miniHint">toy spiking model</div>
            </div>
            <canvas id="raster" width="980" height="150"></canvas>
          </section>
        </div>

        <div class="miniRow">
          <section class="mini">
            <div class="miniBar">
              <div class="miniTitle">Electrode traces</div>
              <div class="miniHint">subset of electrodes</div>
            </div>
            <canvas id="traces" width="980" height="220"></canvas>
          </section>
        </div>
      </div>
    </main>
  </section>

  <script type="module" src={scriptUrl}></script>
</Layout>

<style>
  /* Reuse sim.astro structural classes where possible */
  .simShell {
    margin-top: 14px;
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 12px;
    align-items: start;
  }

  .panel {
    padding: 16px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  .panelSection + .panelSection {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px dashed var(--border);
  }

  .panelTitle {
    font-weight: 700;
    margin-bottom: 10px;
  }

  .lab {
    display: block;
    font-size: 0.95em;
    line-height: 1.4;
    margin: 0 0 12px;
  }

  .rangeRow {
    margin-top: 6px;
  }

  .rangeMeta {
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    font-size: 0.88em;
  }

  .muted {
    opacity: 0.72;
  }

  .stage {
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
    overflow: hidden;
  }

  .stageBar {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
  }

  .stageTitle {
    font-weight: 800;
  }

  .stageHint {
    opacity: 0.68;
    font-size: 0.95em;
  }

  .stageBody {
    padding: 12px;
  }

  .c3d {
    width: 100%;
    height: 460px;
    display: block;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.06);
  }

  .miniRow {
    margin-top: 12px;
  }

  .mini {
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
    background: rgba(255, 255, 255, 0.03);
  }

  .miniBar {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
  }

  .miniTitle {
    font-weight: 700;
  }

  .miniHint {
    opacity: 0.65;
    font-size: 0.92em;
  }

  canvas {
    width: 100%;
    display: block;
  }

  .card {
    padding: 22px 22px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
  }

  @media (max-width: 980px) {
    .simShell {
      grid-template-columns: 1fr;
    }
    .c3d {
      height: 420px;
    }
  }
</style>
